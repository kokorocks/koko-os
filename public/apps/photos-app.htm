<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Advanced Gallery Manager</title>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/nanogallery2@3.0.5/dist/css/nanogallery2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/nanogallery2@3.0.5/dist/jquery.nanogallery2.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* APP STYLING */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #111; color: #fff; }
        
        /* Toolbar */
        .app-toolbar { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: #222; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .btn { background: #333; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-primary { background: #007AFF; }
        .btn-danger { background: #FF3B30; }
        .btn:active { transform: scale(0.95); }

        /* Modal Overlay */
        #editor-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 99999; backdrop-filter: blur(5px); }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: #2c2c2e; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; }
        
        /* Map Container */
        #map-container { height: 200px; width: 100%; }
        
        /* Form */
        .form-container { padding: 20px; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 12px; color: #8e8e93; margin-bottom: 5px; }
        input, textarea { width: 100%; background: #1c1c1e; border: 1px solid #3a3a3c; color: white; padding: 10px; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        textarea { resize: none; height: 80px; }
        
        .modal-footer { padding: 15px; background: #2c2c2e; border-top: 1px solid #3a3a3c; display: flex; justify-content: flex-end; gap: 10px; }

        /* Custom Toast Notification */
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 10000; }
    </style>
</head>
<body>

    <div class="app-toolbar">
        <h3 style="margin:0;">GalleryOS</h3>
        <button class="btn btn-primary" onclick="triggerAddNew()"><i class="fas fa-plus"></i> Add Photo</button>
    </div>

    <div id="nanogallery2"></div>

    <div id="editor-modal">
        <div class="modal-content">
            <div id="map-container"></div>
            
            <div class="form-container">
                <h3 style="margin-top:0">Details</h3>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="meta-title">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="meta-desc"></textarea>
                </div>
                <div class="form-group">
                    <label>Coordinates (Lat, Lng)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="meta-lat" readonly style="background:#111; color:#777;">
                        <input type="text" id="meta-lng" readonly style="background:#111; color:#777;">
                    </div>
                </div>
                <button class="btn btn-danger" id="btn-delete" style="width:100%; justify-content: center; margin-top:10px;">
                    <i class="fas fa-trash"></i> Delete from Library
                </button>
            </div>

            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveMetadata()">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="toast">Saved!</div>

    <script>
        // --- 1. MOCK DATABASE (State Management) ---
        // In a real app, this would be fetched from an API
        let galleryData = [
            {
                src: 'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
                srct: 'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80',
                title: 'Mountain View',
                description: 'A beautiful morning hike.',
                ID: 101,
                lat: 46.577, 
                lng: 7.905 // Swiss Alps coords
            },
            {
                src: 'https://images.unsplash.com/photo-1550948537-130a1ce83314?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
                srct: 'https://images.unsplash.com/photo-1550948537-130a1ce83314?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80',
                title: 'Urban Lights',
                description: 'Night photography in Tokyo.',
                ID: 102,
                lat: 35.676,
                lng: 139.650 // Tokyo coords
            }
        ];

        let currentEditingId = null;
        let mapInstance = null;
        let markerInstance = null;

        // --- 2. INITIALIZE GALLERY ---
        function initGallery() {
            jQuery("#nanogallery2").nanogallery2({
                items: galleryData,
                thumbnailWidth: 'auto',
                thumbnailHeight: 200,
                thumbnailGutterWidth: 5,
                thumbnailGutterHeight: 5,
                
                // Lightbox Configuration
                viewerToolbar: {
                    display: true,
                    standard: 'label',
                    // We add a custom button 'infoButton'
                    minimized: 'minimizeButton, label, infoButton, fullscreenButton, closeButton' 
                },
                viewerTools: {
                    topLeft: 'label',
                    topRight: 'customInfo, zoomButton, closeButton' // 'customInfo' is our hook
                },
                
                // Custom Icon for Metadata/Map
                icons: {
                    viewerCustomTool1: '<i class="fas fa-info-circle" style="font-size: 20px; color: #fff; text-shadow: 0 0 5px #000;"></i>'
                },

                // Event handling for the custom button
                fnImgToolbarCustClick: function(customElementName, $customIcon, item) {
                    if (customElementName === 'customInfo') {
                        openEditor(item);
                    }
                },

                // Mobile Responsive
                breakpoints: [
                    { breakpoints: 'xs', thumbnailHeight: 120 },
                    { breakpoints: 'sm', thumbnailHeight: 180 },
                    { breakpoints: 'md', thumbnailHeight: 250 }
                ],
                
                locationHash: false
            });
        }

        $(document).ready(function() {
            initGallery();
        });

        // --- 3. MAP & EDITOR LOGIC ---

        // REPLACE your existing openEditor function with this:

function openEditor(item) {
    console.log("Clicked Item ID:", item.ID); // Debugging: See what ID the gallery sends

    // 1. SAFE SEARCH: Find the object, but handle type mismatch (string vs number)
    let dataObj = galleryData.find(x => x.ID == item.ID);

    // 2. ERROR PREVENTION: If not found, stop here so we don't crash
    if (!dataObj) {
        console.error("Could not find metadata for image ID:", item.ID);
        alert("Error: Metadata not found for this image.");
        return; 
    }

    // 3. Populate form safely
    currentEditingId = item.ID;
    $('#meta-title').val(dataObj.title || ""); // Use dataObj, not item, to ensure we edit source
    $('#meta-desc').val(dataObj.description || "");
    
    let lat = dataObj.lat || 0;
    let lng = dataObj.lng || 0;

    $('#meta-lat').val(lat);
    $('#meta-lng').val(lng);

    // Show Modal
    $('#editor-modal').fadeIn(200);

    // Initialize Map
    setTimeout(() => {
        if (!mapInstance) {
            mapInstance = L.map('map-container').setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(mapInstance);
        } else {
            mapInstance.invalidateSize(); 
            mapInstance.setView([lat, lng], 13);
        }

        if (markerInstance) mapInstance.removeLayer(markerInstance);
        markerInstance = L.marker([lat, lng]).addTo(mapInstance)
            .bindPopup("Photo Location").openPopup();
    }, 100);
}

        function closeModal() {
            $('#editor-modal').fadeOut(200);
        }

        // --- 4. SAVE / DELETE / ADD LOGIC ---

        function saveMetadata() {
            // 1. Update the local data array
            let index = galleryData.findIndex(x => x.ID == currentEditingId);
            if (index !== -1) {
                galleryData[index].title = $('#meta-title').val();
                galleryData[index].description = $('#meta-desc').val();
                // (Note: In a real app, you would send a POST request here)
            }

            // 2. Refresh Gallery to show changes
            $('#nanogallery2').nanogallery2('destroy');
            initGallery();

            closeModal();
            showToast("Metadata Saved!");
        }

        $('#btn-delete').click(function() {
            if(!confirm("Are you sure you want to delete this photo?")) return;

            // Remove from array
            galleryData = galleryData.filter(x => x.ID !== currentEditingId);
            
            // Refresh
            $('#nanogallery2').nanogallery2('destroy');
            initGallery();
            
            closeModal();
            showToast("Photo Deleted");
        });

        function triggerAddNew() {
            // Simulating adding a file
            let newID = Math.floor(Math.random() * 10000);
            galleryData.unshift({
                src: 'https://images.unsplash.com/photo-1501854140884-074bf6bca23c?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
                srct: 'https://images.unsplash.com/photo-1501854140884-074bf6bca23c?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80',
                title: 'New Upload ' + newID,
                description: 'Just added!',
                ID: newID,
                lat: 48.8566, // Default to Paris
                lng: 2.3522
            });

            $('#nanogallery2').nanogallery2('destroy');
            initGallery();
            showToast("New Photo Added");
        }

        function showToast(msg) {
            let t = $('#toast');
            t.text(msg).css('opacity', 1);
            setTimeout(() => t.css('opacity', 0), 2000);
        }

    </script>
</body>
</html>