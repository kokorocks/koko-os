<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Depth Layers with Real ML Depth (Depth Anything)</title>

<style>
body,html{margin:0;padding:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;background:#eef2f3;font-family:sans-serif}
#phone{position:relative;width:360px;height:760px;background:#000;border-radius:40px;overflow:hidden;box-shadow:0 30px 60px rgba(0,0,0,0.5)}
.layer{position:absolute;inset:0;background-size:cover;background-position:center;pointer-events:none}
.back{z-index:1} .mid{z-index:3} .front{z-index:5}
.clock{position:absolute;top:200px;width:100%;text-align:center;color:white;z-index:4;text-shadow:0 8px 30px rgba(0,0,0,0.4)}
.clock .time{font-size:90px;font-weight:700;line-height:0.9}
.clock .date{font-size:18px;opacity:0.9}
.bubble{position:absolute;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,0.15);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,0.3);top:330px;left:120px;z-index:4}
#loader{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:white;font-size:14px;z-index:10;background:black}
</style>
</head>
<body>

<div id="phone">
  <div id="loader">Estimating depthâ€¦</div>
  <div id="back" class="layer back"></div>
  <div id="mid" class="layer mid"></div>
  <div id="front" class="layer front"></div>
  <div class="clock">
    <div id="date"></div>
    <div class="time" id="time"></div>
  </div>
  <div class="bubble"></div>
</div>

<img id="img" crossorigin="anonymous" hidden
src="https://images.unsplash.com/photo-1554629947-334ff61d85dc?q=80&w=436&auto=format&fit=crop">

<script type="module">
// Transformers.js import from CDN
import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers/dist/transformers.min.js';

// Clock update
function updateClock() {
  const d = new Date();
  document.getElementById('time').textContent = `${d.getHours() % 12 || 12}:${String(d.getMinutes()).padStart(2,'0')}`;
  document.getElementById('date').textContent = d.toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'});
}
setInterval(updateClock,1000);
updateClock();

// Depth pipeline
async function runDepth() {
  const img = document.getElementById('img');
  const depthEstimator = await pipeline('depth-estimation', 'onnx-community/depth-anything-v2-small', { quantized: true });

  // Infer depth
  const result = await depthEstimator(img.src);
  const depth = result.depth; // relative depth map

  // Create depth mask canvases
  const w = img.naturalWidth, h = img.naturalHeight;

  function makeMask(min, max) {
    const c = document.createElement('canvas');
    c.width = w; c.height = h;
    const ctx = c.getContext('2d');
    const id = ctx.createImageData(w, h);
    for (let i = 0; i < depth.length; i++) {
      const v = depth[i];
      id.data[i*4+3] = (v >= min && v < max) ? 255 : 0;
    }
    ctx.putImageData(id, 0, 0);
    return c.toDataURL();
  }

  const backMask = makeMask(0, 0.33);
  const midMask  = makeMask(0.33, 0.66);
  const frontMask= makeMask(0.66, 1);

  ['back','mid','front'].forEach((id, idx) => {
    const el = document.getElementById(id);
    el.style.backgroundImage = `url(${img.src})`;
    el.style.maskImage = `url(${[backMask,midMask,frontMask][idx]})`;
    el.style.webkitMaskImage = el.style.maskImage;
    el.style.maskSize = 'cover';
  });

  document.getElementById('loader').remove();
}

// Wait for image to load
document.getElementById('img').onload = runDepth;
</script>

</body>
</html>
